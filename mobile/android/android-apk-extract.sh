#!/bin/bash

if [ $# -eq 1 ]; then
    app_name="$1"
else
    echo "You need specify almost 1 argument, and the is the app name!"
    exit 1
fi

adb_bin=$(command -v adb)
devices_list=("$(${adb_bin} devices | grep -v "^List.of.devices.attached" | awk '{print $1}' | sed '/^$/d')")

if [ "${#devices_list[@]}" -gt 0 ]; then
    for device in "${devices_list[@]}"; do
        package_name="$(${adb_bin} -s "${device}" shell pm list packages -3 | grep -i "${app_name}" 2> /dev/null | awk -F':' '{print $2}')"
        if [ -z "${package_name}" ]; then
            echo "The ${device} doesn't have the app!"
            continue
        fi
        device_name="$(${adb_bin} -s ${device} shell getprop ro.product.brand)-$(${adb_bin} -s ${device} shell getprop ro.product.system.device)"
        apk_files=($(${adb_bin} -s "${device}" shell pm path "${package_name}" 2> /dev/null | awk -F':' '{print $2}'))
        apks_extracted_dir="/tmp/${device_name}/${package_name}"
        [ ! -d "${apks_extracted_dir}" ] && mkdir -p "${apks_extracted_dir}"
        if [ "${#apk_files[@]}" -ge 1 ]; then
            echo "Extracting ${#apk_files[@]} apk files from ${device_name}..."
            for apk in "${apk_files[@]}"; do
                ${adb_bin} -s "${device}" pull "${apk}" "${apks_extracted_dir}"
                unset apk
            done
            echo "The apk files might be find in the ${apks_extracted_dir} directory."
            unset apk_files
        fi
        unset device
        unset package_name
        unset device_name
        unset apks_extracted_dir
    done
else
    echo "It wasn't possible to find a android device do extract an apk!"
fi

unset app_name
unset devices_list
