/* 
 * script by Sameer Bhatt
 * https://bhattsameer.github.io/2021/06/23/Intercepting-flutter-iOS-application.html 
 *
 */

function hook_ssl_verify_result(address)
{
    Interceptor.attach(address, {
    onEnter: function(args) {
        console.log("Disabling SSL validation")
    },
    onLeave: function(retval) {
        retval.replace(0x1);
    }
    });
}

function disablePinning()
{
    /* The variable pattern is the point that you need to find using ghidra and put the correct value below  */
    var pattern = "d7 02 00 b4 b2 06 00 94 80 02 00 b4 f8 03 00 aa 17 04 00 f9 1b 00 00 b9 6a 28 08 94 e3 d8 ff 97"
    Process.enumerateRangesSync('r-x').filter(function (m) 
    {
        if (m.file) return m.file.path.indexOf('Flutter') > -1;
        return false;
    }).forEach(function (r) 
    {
        Memory.scanSync(r.base, r.size, pattern).forEach(function (match) {
            console.log('[+] ssl_verify_result found at: ' + match.address.toString());
            hook_ssl_verify_result(match.address);
        });
    });
 }
setTimeout(disablePinning, 1000)
