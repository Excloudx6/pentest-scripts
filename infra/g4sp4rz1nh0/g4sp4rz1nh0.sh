#!/bin/bash

# Colours
red="\e[31m"
green="\e[32m"
yellow="\e[33m"
reset="\e[0m"

# Banner
echo -e "\t                                                       "
echo -e "\t                      .-.                              "
echo -e "\t         heehee      /aa \_                            "
echo -e "\t                   __\-  / )                 .-.       "
echo -e "\t         .-.      (__/    /        haha    _/oo \      "
echo -e "\t       _/ ..\       /     \               ( \U  /__    "
echo -e "\t      ( \  u/__    /       \__             \/   ___)   "
echo -e "\t       \    \__)   \_.-._._   )  .-.       /     \     "
echo -e "\t       /     \             \`-\`  / ee\_    /       \_ "
echo -e "\t    __/       \               __\  o/ )   \_.-.__   )  " 
echo -e "\t   (   _._.-._/     hoho     (___   \/           '-'   "
echo -e "\t    '-'                        /     \                 "
echo -e "\t    BOOOOOOO                 _/       \    teehee      "
echo -e "\t                            (_____.-._/                "
echo -e "\t                                                       "

dependency(){
echo "This script has some dependencies and without it can't be executed.
Please install all dependencies and configure the settings.cfg file 
with the path for the binaries. 

  == DEPENDENCIES:== 
    1) tor          --> version 0.3.3.6 or earlier - https://www.torproject.org/
    2) privoxy      --> version 3.0.26  or earlier - http://www.privoxy.org/
    3) haproxy      --> version 1.7.5-2 or earlier - https://www.haproxy.org/
    4) proxychains  --> version 3.1     or earlier - https://sourceforge.net/projects/proxychains/
    5) expect       --> version 5.45    or earlier - https://sourceforge.net/projects/expect/
"
exit 1
}

usage(){
echo -e "Usage:
Sintax sample: bash g4sp4rz1nh0.sh -i 2 -c 15 -re exit -l
       
 -c|--countries         : Defines the number of (C)OUNTRIES.
 -i|--instances         : Defines the number of (I)NSTANCES per country.
 -k|--kill              : Will terminate previous execution of $0,
                          ignoring all other options.
 -l|--local             : Configure a local infrastructure for g4sp4r1nh0
                          the local infrastructure containing HAproxy, Privoxy
                          and TOR.
 -r|--remote            : Configure a remote infrastructure for g4sp4rz1nh0
                          the local infrastructure containing HAproxy, Privoxy
                          and TOR through VPS running a VPN.
 -re|--relay-enforcing  : Defines the (R)ELAY (E)NFORCING approach.

                         Ps: To setup the list of countries you must edit the configuration
                         file. This options will control how the script will manipulate the
                         TOR ENTRY NODE and the TOR EXIT NODE.
       
                         The options for the (R)elay (E)nforcing are:
                         1) entry: Sets a specific country as ENTRY relay
                                   and will use a different country as EXIT relay.
                                   The load balancing algorithm is: Round Robin.

                         2) exit:  Sets a specific country as EXIT relay
                                   and will use a different country as ENTRY relay.
                                   This option give you the control of the EXIT relays and
                                   could be used to bypass GeoIP protections.
                                   Whoever reduces the number of EXIT realys available.
                                   The load balancing algorithm is: Round Robin.

                         3) speed: This option is the fastest option because reduces the
                                   delay between the hops of relays inside TOR network by
                                   setting the same country as ENTRY and EXIT node.
                                   All other countries will be set as EXCLUDE NODES, so the
                                   middle relay will hopefully also be selected inside the
                                   same country.

                                   The load balancing algorithm for this option is:
                                   Least Connections Round Robin.

                                   This algorithm sends the next request for the instances
                                   with least number of request in the queue but still
                                   performing the load balancing between all other instances.

                                   Do not use this option for sensitive activities because
                                   it could reduce the security if you consider that your
                                   adversary could easily compromise a TOR ENTRY-NODE and
                                   a TOR EXIT-NODE in the same country.
                                   Some contries doesn't have ENTRY GUARDS and EXIT NODES
                                   enougth to create valid circuits.
                                   Keep your eyes on the health check URL to identify
                                   countries with this issue. By default the health check is:
                                   http://127.0.0.1:63537/g4sp4rz1nh0_status
"
exit 1
}

# Check binaries
if [[ -z $(command -v tor) ]]; then echo -e "Please install tor!\n" ; dependency ; fi
if [[ -z $(command -v privoxy) ]]; then echo -e "Please install privoxy!\n" ; dependency ; fi
if [[ -z $(command -v haproxy) ]]; then echo -e "Please install haproxy!\n" ; dependency ; fi
if [[ -z $(command -v proxychains) ]]; then echo -e "Please install proxychains!\n" ; dependency ; fi
if [[ -z $(command -v expect) ]]; then echo -e "Please install expect!\n" ; dependency ; fi
if [[ -z $(command -v iptables) ]]; then echo -e "Please install iptables!\n" ; dependency ; fi

options+=(-c --countries -i --instances -k --kill -l --local -m --mode -r --remote -re --relay-enforcing)

check_argument(){
    if [[ "${options[@]}" =~ "$1" ]]; then
        echo -e "The argument of ${yellow}\"$1\"${reset} it can not be ${red}\"$2\"${reset}, please, ${yellow} specify a valid one${reset}.\n"
        usage
    fi
}

# Menu
while [[ $# -ne 0 ]]; do
    case $1 in
        -c|--countries)
            COUNTRIES="$2"
            check_argument "${COUNTRIES}"
            if [[ -z "${COUNTRIES}" ]] || [[ ! $2 =~ [0-9] ]]; then \
                echo -e "You need to specify a number to \"-c\" option!\n" ; usage; fi
            shift 2 ;;
        -i|--instances)
            TOR_INSTANCES="$2"
            check_argument "${TOR_INSTANCES}"
            if [[ -z "${TOR_INSTANCES}" ]] || [[ ! "${TOR_INSTANCES}" =~ [0-9] ]]; then \
                echo -e "You need to specify a number to \"-i\" options!\n"; usage; fi
            shift 2 ;;
        -k|--kill)
            if [[ -n "${TOR_INSTANCES}" ]] || \
                [[ -n "${COUNTRIES}" ]] || \
                [[ -n "${COUNTRY_LIST_CONTROLS}" ]]; then
                echo "Ignoring all other options."
            fi
            if [[ -s "${PWD}/functions/01_g4sp4rz1nh0_common_functions.sh" ]]; then
                source "${PWD}/functions/01_g4sp4rz1nh0_common_functions.sh"
                echo "Ending the previous execution of the $0!"
                kill_g4sp4rz1nh0_execution
                exit 0
            else
                echo "Unable to find the functions/01_g4sp4rz1nh0_common_functions.sh \
                    file for the kill_g4sp4rz1nh0_execution function!"
                exit 1
            fi ;;
        -l|--local)
            if [[ "${INFRA}" == "remote" ]]; then
                echo "You can't use -r|--remote with -l|--local to define the infrastructure."
                echo "Choice only one and rerun the $0."
                usage
            else
                unset INFRA
                INFRA=local
            fi
            shift ;;
        -m|--mode)
            MODE=$2
            check_argument "${MODE}"
            MODE_OPTIONS=("paranoid" "relax")
            [[ ! "${MODE_OPTIONS[*]}" =~ "${MODE}" ]] && \ 
                echo "You need to inform paranoid or relax to change the value of CHANGE_COUNTRY_INTERVAL!" ; \
                usage
            [[ "$(echo $2 | tr A-Z a-z)" == "paranoid" ]] && unset CHANGE_COUNTRY_INTERVAL; CHANGE_COUNTRY_INTERVAL="30"
            [[ "$(echo $2 | tr A-Z a-z)" == "relax" ]] && unset CHANGE_COUNTRY_INTERVAL; CHANGE_COUNTRY_INTERVAL="120"
            shift 2 ;;
        -r|--remote)
            if [[ "${INFRA}" == "local" ]]; then
                echo "You can't use -l|--local with -r|--remote to define the infrastructure."
                echo "Choice only one and rerun the $0."
                usage
            else
                unset INFRA
                INFRA=remote
            fi
            shift ;;
        -re|--relay-enforcing)
            COUNTRY_LIST_CONTROLS="$2"
            check_argument "${COUNTRY_LIST_CONTROLS}"
            RELAY_ENFORCING_OPTIONS=("entry" "exit" "speed")
            [[ ! "${RELAY_ENFORCING_OPTIONS[*]}" =~ "${COUNTRY_LIST_CONTROLS}" ]] &&
                echo -e "You need to specify a string to \"-re|--relay-enforcing\" option!\n" ; usage
            shift 2 ;;
        -?*|*)
            usage
    esac
done

if [[ -z "${TOR_INSTANCES}" ]] || [[ -z "${COUNTRIES}" ]] || [[ -z "${COUNTRY_LIST_CONTROLS}" ]]; then 
    echo -e "Please inform the quantitative of parameters necessary to execute the $0!\n" 
    usage
fi

if [ "${infra}" == "none" ] ; then
    echo -e "You need to specify what type of infrastructure you will use, -l|--local or -r|--remote.\n"
    usage
fi

# Checking of configurations and functions files
if [ -d configs/ ]; then
    # This is the correct sequence to load the g4sp4rz1nh0 configuration
    configs=(g4sp4rz1nh0.cfg tor.cfg privoxy.cfg ha.cfg)
    for cfg in "${configs[@]}"; do
        if [ -s "${PWD}/configs/${cfg}" ]; then
            source "${PWD}/configs/${cfg}"
        else
            echo "The configuration file \"${cfg}\" is missing, please check for its absence."
            exit 1
        fi
    done
else
    echo "Directory \"configs\" does not exist, please check directory."
    exit 1
fi
if [ -d functions/ ]; then
    functions+=(01_g4sp4rz1nh0_common_functions.sh 02_create_initial_config_files.sh 03_tor_common_functions.sh)
    functions+=(04_create_new_instance_files.sh 05_boot_tor_instances.sh 06_g4sp4rz1nh0_starts_the_game.sh)
    for function in "${functions[@]}"; do
        if [ -s "${PWD}/functions/${function}" ]; then
            source "${PWD}/functions/${function}"  
        else
            echo "The function file \"${function}\" is missing, please check for its absence."
            exit 1
        fi
    done
else
    echo "Directory \"functions\" does not exist, please check directory."
    exit 1
fi

