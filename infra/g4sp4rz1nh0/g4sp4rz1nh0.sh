#!/bin/bash

# Banner
echo -e "\t                                                       "
echo -e "\t                      .-.                              "
echo -e "\t         heehee      /aa \_                            "
echo -e "\t                   __\-  / )                 .-.       "
echo -e "\t         .-.      (__/    /        haha    _/oo \      "
echo -e "\t       _/ ..\       /     \               ( \U  /__    "
echo -e "\t      ( \  u/__    /       \__             \/   ___)   "
echo -e "\t       \    \__)   \_.-._._   )  .-.       /     \     "
echo -e "\t       /     \             \`-\`  / ee\_    /       \_ "
echo -e "\t    __/       \               __\  o/ )   \_.-.__   )  " 
echo -e "\t   (   _._.-._/     hoho     (___   \/           '-'   "
echo -e "\t    '-'                        /     \                 "
echo -e "\t    BOOOOOOO                 _/       \    teehee      "
echo -e "\t                            (_____.-._/                "
echo -e "\t                                                       "

if [ -s "${PWD}/functions/00_usage.sh" ]; then source "${PWD}/functions/00_usage.sh" ;
else echo "The function file usage.sh is missing, please check for its absence." ; exit 1; fi

# Menu
while [[ $# -ne 0 ]]; do
    case $1 in
        -c|--countries)
            COUNTRIES="$2"
            if [[ -z "${COUNTRIES}" ]] || [[ ! $2 =~ [0-9] ]]; then \
                echo -e "You need to specify a number to \"-c\" option!\n" ; usage; fi
            shift 2 ;;
        -i|--instances)
            TOR_INSTANCES="$2"
            if [[ -z "${TOR_INSTANCES}" ]] || [[ ! $2 =~ [0-9] ]]; then \
                echo -e "You need to specify a number to \"-i\" options!\n"; usage; fi
            shift 2 ;;
        -k|--kill)
            if [[ -n "${TOR_INSTANCES}" ]] || \
                [[ -n "${COUNTRIES}" ]] || \
                [[ -n "${COUNTRY_LIST_CONTROLS}" ]]; then
                echo "Ignoring all other options."
            fi
            if [[ -s "${PWD}/functions/01_g4sp4rz1nh0_common_functions.sh" ]]; then
                source "${PWD}/functions/01_g4sp4rz1nh0_common_functions.sh"
                echo "Ending the previous execution of the $0!"
                kill_g4sp4rz1nh0_execution
                exit 0
            else
                echo "Unable to find the functions/01_g4sp4rz1nh0_common_functions.sh \
                    file for the kill_g4sp4rz1nh0_execution function!"
                exit 1
            fi ;;
        -l|--local)
            [[ "${infra}" == "none" ]] && unset infra
            [[ "${infra}" == "remote" ]] && \
                echo "You can't use -r|--remote with -l|--local to define the infrastructure." ; \
                echo "Choice only one and rerun the $0." ; \
                usage
            infra=local
            shift ;;
        -r|--remote)
            [[ "${infra}" == "none" ]] && unset infra
            [[ "${infra}" == "local" ]] && \
                echo "You can't use -l|--local with -r|--remote to define the infrastructure." ; \
                echo "Choice only one and rerun the $0." ; \
                usage
            infra=remote
            shift ;;
        -re|--relay-enforcing)
            relay_enforcing_options=("entry" "exit" "speed")
            COUNTRY_LIST_CONTROLS="$2"
            if [[ -z "${COUNTRY_LIST_CONTROLS}" ]] || \
                [[ !  "${relay_enforcing_options[*]}" =~ "${COUNTRY_LIST_CONTROLS}" ]]; then \
                echo -e "You need to specify a string to \"-re\" option!\n" ; usage; fi
            shift 2 ;;
        -?*|*)
            usage
    esac
done

if [[ -z "${TOR_INSTANCES}" ]] || [[ -z "${COUNTRIES}" ]] || [[ -z "${COUNTRY_LIST_CONTROLS}" ]]; then 
    echo -e "Please inform the quantitative of parameters necessary to execute the $0!\n" 
    usage
fi

if [ "${infra}" == "none" ] ; then
    echo -e "You need to specify what type of infrastructure you will use, -l|--local or -r|--remote.\n"
    usage
fi

# Checking of configurations and functions files
if [ -d configs/ ]; then
    # This is the correct sequence to load the g4sp4rz1nh0 configuration
    configs=(g4sp4rz1nh0.cfg tor.cfg privoxy.cfg ha.cfg)
    for cfg in "${configs[@]}"; do
        if [ -s "${PWD}/configs/${cfg}" ]; then
            source "${PWD}/configs/${cfg}"
        else
            echo "The configuration file \"${cfg}\" is missing, please check for its absence."
            exit 1
        fi
    done
else
    echo "Directory \"configs\" does not exist, please check directory."
    exit 1
fi
if [ -d functions/ ]; then
    functions+=(01_g4sp4rz1nh0_common_functions.sh 02_create_initial_config_files.sh 03_tor_common_functions.sh)
    functions+=(04_create_new_instance_files.sh 05_boot_tor_instances.sh 06_g4sp4rz1nh0_starts_the_game.sh)
    for function in "${functions[@]}"; do
        if [ -s "${PWD}/functions/${function}" ]; then
            source "${PWD}/functions/${function}"  
        else
            echo "The function file \"${function}\" is missing, please check for its absence."
            exit 1
        fi
    done
else
    echo "Directory \"functions\" does not exist, please check directory."
    exit 1
fi
