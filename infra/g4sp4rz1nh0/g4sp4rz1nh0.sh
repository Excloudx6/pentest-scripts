#!/bin/bash

# Colours
red="\e[31m"
green="\e[32m"
yellow="\e[33m"
reset="\e[0m"

# Banner
echo -e "\t                                                       "
echo -e "\t                      .-.                              "
echo -e "\t         heehee      /aa \_                            "
echo -e "\t                   __\-  / )                 .-.       "
echo -e "\t         .-.      (__/    /        haha    _/oo \      "
echo -e "\t       _/ ..\       /     \               ( \U  /__    "
echo -e "\t      ( \  u/__    /       \__             \/   ___)   "
echo -e "\t       \    \__)   \_.-._._   )  .-.       /     \     "
echo -e "\t       /     \             \`-\`  / ee\_    /       \_ "
echo -e "\t    __/       \               __\  o/ )   \_.-.__   )  " 
echo -e "\t   (   _._.-._/     hoho     (___   \/           '-'   "
echo -e "\t    '-'                        /     \                 "
echo -e "\t    BOOOOOOO                 _/       \    teehee      "
echo -e "\t                            (_____.-._/                "
echo -e "\t                                                       "

if [[ ! -s "${PWD}/functions/000_initial.sh" ]]; then 
    echo "An important file needed for g4sp4rz1nh0!"
    exit 1
else
    source "${PWD}/functions/000_initial.sh"
fi

options+=(-c --countries -hs --hidden-services -i --instances -k --kill -l --local -m --mode -r --remote -re --relay-enforcing)

check_argument(){
    if [[ "${options[@]}" =~ "$1" ]]; then
        echo -e "The argument of ${yellow}\"$1\"${reset} it can not be ${red}\"$2\"${reset}, please, ${yellow} specify a valid one${reset}.\n"
        usage
    fi
}

# Menu
while [[ $# -ne 0 ]]; do
    case $1 in
        -c|--countries)
            COUNTRIES="$2"
            check_argument "${COUNTRIES}"
            if [[ -z "${COUNTRIES}" ]] || [[ ! $2 =~ [0-9] ]]; then \
                echo -e "You need to specify a number to \"-c\" option!\n" ; usage; fi
            shift 2 ;;
        -hs|--hidden-services)
            unset HIDDEN_SERVICES_ACTIVE
            HIDDEN_SERVICES_ACTIVE="yes"
            # Check binaries
            for bin in expect; do
                if [[ -z $(command -v "${bin}") ]]; then
                    echo -e "Please install ${bin}!\n"
                    dependency
                fi
            done
            shift ;;
        -i|--instances)
            TOR_INSTANCES="$2"
            check_argument "${TOR_INSTANCES}"
            if [[ -z "${TOR_INSTANCES}" ]] || [[ ! "${TOR_INSTANCES}" =~ [0-9] ]]; then \
                echo -e "You need to specify a number to \"-i\" options!\n"; usage; fi
            shift 2 ;;
        -k|--kill)
            if [[ -n "${TOR_INSTANCES}" ]] || \
                [[ -n "${COUNTRIES}" ]] || \
                [[ -n "${COUNTRY_LIST_CONTROLS}" ]]; then
                echo "Ignoring all other options."
            fi
            if [[ -s "${PWD}/functions/099_utils.sh" ]]; then
                source "${PWD}/functions/099_utils.sh"
                echo "Ending the previous execution of the $0!"
                kill_g4sp4rz1nh0_execution
                exit 0
            else
                echo "Unable to find the functions/01_g4sp4rz1nh0_common_functions.sh \
                    file for the kill_g4sp4rz1nh0_execution function!"
                exit 1
            fi ;;
        -l|--local)
            if [[ "${INFRA}" == "remote" ]]; then
                echo "You can't use -r|--remote with -l|--local to define the infrastructure."
                echo "Choice only one and rerun the $0."
                usage
            else
                unset INFRA
                INFRA=local
                # Check binaries
                for bin in haproxy tor; do
                    if [ -z $(command -v "${bin}") ]; then
                        echo -e "Please install ${bin}!\n"
                        dependency
                    fi
                done
                shift
            fi
            ;;
        -m|--mode)
            MODE=$2
            check_argument "${MODE}"
            MODE_OPTIONS=("paranoid" "relax")
            [[ ! "${MODE_OPTIONS[*]}" =~ "${MODE}" ]] && \ 
                echo "You need to inform paranoid or relax to change the value of CHANGE_COUNTRY_INTERVAL!" ; \
                usage
            [[ "$(echo $2 | tr A-Z a-z)" == "paranoid" ]] && unset CHANGE_COUNTRY_INTERVAL; CHANGE_COUNTRY_INTERVAL="30"
            [[ "$(echo $2 | tr A-Z a-z)" == "relax" ]] && unset CHANGE_COUNTRY_INTERVAL; CHANGE_COUNTRY_INTERVAL="120"
            shift 2 ;;
        -r|--remote)
            if [[ "${INFRA}" == "local" ]]; then
                echo "You can't use -l|--local with -r|--remote to define the infrastructure."
                echo "Choice only one and rerun the $0."
                usage
            else
                unset INFRA
                INFRA=remote
                # Check binaries
                for bin in ansible haproxy iptables openvpn terraform tor; do
                    if [ -z $(command -v "${bin}") ]; then
                        echo -e "Please install ${bin}!\n"
                        dependency
                    fi
                done
                shift
            fi
            ;;
        -re|--relay-enforcing)
            COUNTRY_LIST_CONTROLS="$2"
            check_argument "${COUNTRY_LIST_CONTROLS}"
            RELAY_ENFORCING_OPTIONS=("entry" "exit" "speed")
            if [[ ! "${RELAY_ENFORCING_OPTIONS[*]}" =~ "${COUNTRY_LIST_CONTROLS}" ]]; then
                echo -e "You need to specify a string to \"-re|--relay-enforcing\" option!\n"
                usage
            else
                # Define the load-balance algoritm 
                if [ "${COUNTRY_LIST_CONTROLS}" != "speed" ]; then
	                LOAD_BALANCE_ALGORITHM="roundrobin"
	                HAPROXY_HTTP_REUSE="never"
                else 
	                LOAD_BALANCE_ALGORITHM="leastconn"
	                HAPROXY_HTTP_REUSE="safe"
                fi
                shift 2
            fi
            ;;
        -?*|*)
            usage
    esac
done

if [[ -z "${TOR_INSTANCES}" || -z "${COUNTRIES}" || -z "${COUNTRY_LIST_CONTROLS}" || "${INFRA}" == "none" ]]; then
    echo -e "Please inform the quantitative of parameters necessary to execute the $0!\n" 
    usage
fi

if [ "${infra}" == "none" ] ; then
    echo -e "You need to specify what type of infrastructure you will use, -l|--local or -r|--remote.\n"
    usage
fi

# Checking of configurations and functions files
if [ -d "${PWD}/configs/" ]; then
    # This is the correct sequence to load the g4sp4rz1nh0 configuration
    configs+=(g4sp4rz1nh0.cfg tor.cfg privoxy.cfg haproxy.cfg)
    [[ "${HIDDEN_SERVICES_ACTIVE}" == "yes" ]] && configs+=(hidden_services.cfg)
    for cfg in "${configs[@]}"; do
        if [ -s "${PWD}/configs/${cfg}" ]; then
            if [[ "${cfg}" == "tor.cfg" && "${COUNTRY_LIST_CONTROLS}" == "speed" ]]; then
                sed -i "s/^StrictNodes=\".\"/StrictNodes=\"0\"/" "${PWD}/configs/tor.cfg"
            else
                sed -i "s/^StrictNodes=\".\"/StrictNodes=\"1\"/" "${PWD}/configs/tor.cfg"
            fi
            source "${PWD}/configs/${cfg}"
        else
            echo "The configuration file \"${cfg}\" is missing, please check for its absence."
            exit 1
        fi
    done
else
    echo "Directory \"configs\" does not exist, please check directory."
    exit 1
fi
if [ -d "${PWD}/functions/" ]; then
    functions+=(001_haproxy.sh 002_tor.sh 003_privoxy.sh 099_utils.sh 999_let_the_fun_begin.sh)
    for function in "${functions[@]}"; do
        if [ -s "${PWD}/functions/${function}" ]; then
            source "${PWD}/functions/${function}"  
        else
            echo "The function file \"${function}\" is missing, please check for its absence."
            exit 1
        fi
    done
else
    echo "Directory \"functions\" does not exist, please check directory."
    exit 1
fi

exit 1
