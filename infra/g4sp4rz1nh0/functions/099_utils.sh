#!/bin/bash

create_initial_structure_files(){
# Create directory and checking if the required structure is ready
if [ "${HIDDEN_SERVICE_ACTIVE}" == "yes" ]; then
    directories=("${g4sp4rz1nh0_TEMP_FILES}" "${TOR_TEMP_FILES}" "${HIDDEN_SERVICE_TEMP_FILES}" "${HAPROXY_TEMP_FILES}")
else
    directories=("${g4sp4rz1nh0_TEMP_FILES}" "${TOR_TEMP_FILES}" "${HAPROXY_TEMP_FILES}")
fi

for dir in "${directories[@]}"; do
    if [ ! -d "${dir}" ]; then
        if ! mkdir -p "${dir}"; then
            [[ "${dir}" == "${g4sprz1nh0_TEMP_FILES}" ]] && touch "${g4sp4rz1nh0_startup_log}"
            echo "The directory ${dir} is necessary and has not been created, check what is happening that $0 is failing to create the directory."
            rm -rf "${g4sp4rz1nh0_TEMP_FILES}"
            exit 1
        fi
    fi
done

chown -R "${USER_ID}" "${g4sp4rz1nh0_TEMP_FILES}"
chmod 700 -R "${g4sp4rz1nh0_TEMP_FILES}"
}

kill_g4sp4rz1nh0_execution(){
    for cmd in "$(command -v tor)" "$(command -v privoxy)" \
        "$(command -v proxychains)" "$(command -v haproxy)" \
        "${TOR_TEMP_FILES}/force_new_circuit.sh" \
        "${g4sp4rz1nh0_TEMP_FILES}/functions/change_country_on_the_fly.sh" ; do
    
        for pid in $(pgrep -f "${cmd}"); do
            kill -9 "${pid}" > /dev/null 2>&1
        done
    done
    rm -rf "${g4sp4rz1nh0_TEMP_FILES}" > /dev/null 2>&1
}

loadbalancing_choice(){
    # Define the load-balance algoritm 
    if test "${COUNTRY_LIST_CONTROLS}" != "speed" ; then
	    LOAD_BALANCE_ALGORITHM="roundrobin"
	    HAPROXY_HTTP_REUSE="never"
    else 
	    LOAD_BALANCE_ALGORITHM="leastconn"
	    HAPROXY_HTTP_REUSE="safe"
    fi
}

setting_proxy(){
# Setting proxy to the system
grep -Ev "Proxies.*TOR|no_proxy|all_proxy|http_proxy|https_proxy|ftp_proxy|rsync_proxy" "/home/${USER_ID}/.bashrc" > .bashrc_temp 
echo "# Proxies TOR" >> .bashrc_temp
echo "export no_proxy=${DO_NOT_PROXY}" >> .bashrc_temp
echo "export all_proxy=http://127.0.0.1:${HAPROXY_MASTER_PROXY_PORT}" >> .bashrc_temp
echo "export http_proxy=http://127.0.0.1:${HAPROXY_MASTER_PROXY_PORT}" >> .bashrc_temp
echo "export https_proxy=https://127.0.0.1:${HAPROXY_MASTER_PROXY_PORT}" >> .bashrc_temp
echo "export ftp_proxy=http://127.0.0.1:${HAPROXY_MASTER_PROXY_PORT}" >> .bashrc_temp
echo "export rsync_proxy=http://127.0.0.1:${HAPROXY_MASTER_PROXY_PORT}" >> .bashrc_temp
mv -f .bashrc_temp "/home/${USER_ID}/.bashrc"
}
