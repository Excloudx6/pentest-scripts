#!/bin/bash

# This function just check if the selected port is available before use it. 
check_if_port_available(){
    # 0(Zero) means that the port is not available and 1 means that this port is available
	PORT_FREE=0 
	REQUESTED_PORT="$1"
	while [ ${PORT_FREE} -lt 1 ]; do 
        # Check if this port is available
        if [[ $(netstat -ln | grep -q ":${REQUESTED_PORT}" 2> /dev/null) ]]; then
			REQUESTED_PORT="$((REQUESTED_PORT + 1))"
            # Call this function again to check if the new port is available
			check_if_port_available "${REQUESTED_PORT}" 
		else
			NEXT_PORT_AVAILABLE="${REQUESTED_PORT}"
            # The port is available. Exit the loop
			PORT_FREE=1 
		fi
	done
}

# This function is executed after the execution of the function: random_country
# This function executes the function boot_tor_instances
boot_tor_per_country(){
    if [ -n "${MY_COUNTRY_LIST}" ]; then
	    for country_code in ${MY_COUNTRY_LIST}; do
		    if [ -n "${country_code}" ]; then
    			CURRENT_COUNTRY=${country_code}
	    		echo "Starting (${TOR_INSTANCES}) TOR instances enforcing the (${COUNTRY_LIST_CONTROLS}) in the COUNTRY: ${CURRENT_COUNTRY}"
                # Call the declared function
		    	boot_tor_instances 
    		fi
	    done
    else
	    echo "Your MY_COUNTRY_LIST is empty!"
        echo "You should define the list of country codes will be used."
        echo "Sample: {US},{IT},{FR},{CA},{CH},{SE},{RU},{CH},{JP},{BR}"
	    exit 1
    fi
}

# This function select the initial random countries.
random_country(){ 
    for c in $(seq "${COUNTRIES}"); do
        # Sub Function to generate the LIST of COUNTRIES
	    remove_duplicate_country(){
		    if [ "${MY_COUNTRY_LIST}" = "FIRST_EXECUTION" ]; then
			    MY_COUNTRY_LIST="${COUNTRY_CANDIDATE}"
    		else
                # If the country candidate was not found in the current country list
	    		if ! grep -q -i "${COUNTRY_CANDIDATE}" "${MY_COUNTRY_LIST}" 2> /dev/null; then
				    MY_COUNTRY_LIST=$(printf '%s\n%s\n' "${MY_COUNTRY_LIST}" "${COUNTRY_CANDIDATE}")
    			else
                    # If the country already exist in the list select another country
	    			sort_country
		    	fi
		    fi
    	}
        # Sub Function to select a random contry
	    sort_country(){ 
		    COUNTRY_CANDIDATE=$(echo "${ACCEPTED_COUNTRIES}" | sed "s|,|\n|g" | sort -R | head -n 1)
            # Call the declared function
    		remove_duplicate_country
	    }
        # Call the declared function
    	sort_country
    done
    # Now we have the list of random countries defined. Let's boot the tor using this random list.
    # Call the declared function
    boot_tor_per_country
}
